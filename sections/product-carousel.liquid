{%- liquid
  assign product = section.settings.product
  assign slide_timings = section.settings.slide_timings | default: '12000,6000'
  assign padding_top = section.settings.padding_top | default: 0
  assign padding_bottom = section.settings.padding_bottom | default: 80
-%}

<div 
  class="grid-block"
  style="
    --span-s: span {{ section.settings.span_s | default: 2 }};
    --start-s: {{ section.settings.start_s | default: 'auto' }};
    --align-s: {{ section.settings.align_s | default: 'center' }};
    
    --span-m: span {{ section.settings.span_m | default: 4 }};
    --start-m: {{ section.settings.start_m | default: 'auto' }};
    --align-m: {{ section.settings.align_m | default: 'center' }};
    
    --span-l: span {{ section.settings.span_l | default: 6 }};
    --start-l: {{ section.settings.start_l | default: 'auto' }};
    --align-l: {{ section.settings.align_l | default: 'center' }};
    
    --span-xl: span {{ section.settings.span_xl | default: 8 }};
    --start-xl: {{ section.settings.start_xl | default: 'auto' }};
    --align-xl: {{ section.settings.align_xl | default: 'center' }};

    padding-top: {{ padding_top }}px;
    padding-bottom: {{ padding_bottom }}px;
  "
>
  {%- if product != blank -%}
    {% render 'product-card', 
      product: product, 
      variant: section.settings.variant,
      timings: slide_timings,
      max_width: section.settings.max_width | append: 'px'
    %}
  {%- else -%}
    <product-card 
      class="product-card {{ section.settings.variant }}"
      data-timings="[{{ slide_timings }}]"
      style="max-width: {{ section.settings.max_width }}px;"
    >
      <div class="product-visual">
        {%- for block in section.blocks -%}
          {%- if block.type == 'slide' -%}
            <div class="slide-container{% if forloop.first %} active{% endif %}" {{ block.shopify_attributes }}>
              {%- if block.settings.image_light -%}
                {{- block.settings.image_light | image_url: width: 1440 | image_tag:
                  class: 'product-image img-light',
                  loading: 'lazy',
                  widths: '375, 550, 750, 1100, 1440',
                  sizes: '(min-width: 1440px) 1440px, 100vw',
                  alt: block.settings.alt_text | default: 'Product image'
                -}}
              {%- elsif block.settings.image_light_url != blank -%}
                <img 
                  src="{{ block.settings.image_light_url }}" 
                  alt="{{ block.settings.alt_text | default: 'Product image' }}"
                  class="product-image img-light"
                  loading="lazy"
                  draggable="false"
                  style="object-position: center;"
                >
              {%- endif -%}
              
              {%- if block.settings.image_dark -%}
                {{- block.settings.image_dark | image_url: width: 1440 | image_tag:
                  class: 'product-image img-dark',
                  loading: 'lazy',
                  widths: '375, 550, 750, 1100, 1440',
                  sizes: '(min-width: 1440px) 1440px, 100vw',
                  alt: block.settings.alt_text | default: 'Product image'
                -}}
              {%- elsif block.settings.image_dark_url != blank -%}
                <img 
                  src="{{ block.settings.image_dark_url }}" 
                  alt="{{ block.settings.alt_text | default: 'Product image' }}"
                  class="product-image img-dark"
                  loading="lazy"
                  draggable="false"
                  style="object-position: center;"
                >
              {%- endif -%}
            </div>
          {%- endif -%}
        {%- endfor -%}
      </div>
      
      {%- assign slide_count = 0 -%}
      {%- for block in section.blocks -%}{%- if block.type == 'slide' -%}{%- assign slide_count = slide_count | plus: 1 -%}{%- endif -%}{%- endfor -%}
      
      {%- if slide_count > 1 -%}
        <div class="card-controls">
          <button class="control-btn" type="button" aria-label="Pause slideshow">
            <svg width="10" height="12" viewBox="0 0 10 12" fill="currentColor" class="icon-pause">
              <rect width="3.5" height="12" rx="1.75" /><rect x="6.5" width="3.5" height="12" rx="1.75" />
            </svg>
            <svg width="10" height="12" viewBox="0 0 10 12" fill="currentColor" class="icon-play u-hidden" style="transform: translateX(2px);">
              <path d="M9.359 5.25391C9.88281 5.58984 9.88281 6.36328 9.359 6.69922L1.47461 11.7246C0.919922 12.0781 0.189453 11.6816 0.189453 11.0117V0.941406C0.189453 0.271484 0.919922 -0.125 1.47461 0.228516L9.359 5.25391Z" />
            </svg>
          </button>
          <div class="dotnav-container" role="tablist">
            {%- for i in (1..slide_count) -%}
              <button class="dotnav-item{% if forloop.first %} active{% endif %}" type="button" role="tab" data-index="{{ forloop.index0 }}">
                <div class="dot-progress"></div>
              </button>
            {%- endfor -%}
          </div>
        </div>
      {%- endif -%}
    </product-card>
  {%- endif -%}
</div>

{% schema %}
{
  "name": "Product Carousel",
  "tag": "section",
  "class": "section-product-carousel grid-container",
  "settings": [
    {
      "type": "product",
      "id": "product",
      "label": "Product"
    },
    {
      "type": "select",
      "id": "variant",
      "label": "Card Variant",
      "options": [
        { "value": "portrait", "label": "Portrait (3:4)" },
        { "value": "prelaunch", "label": "Prelaunch (Responsive)" },
        { "value": "landscape", "label": "Landscape (16:9)" }
      ],
      "default": "prelaunch"
    },
    {
      "type": "range",
      "id": "max_width",
      "min": 600,
      "max": 1920,
      "step": 40,
      "default": 1440,
      "unit": "px",
      "label": "Max Width"
    },
    {
      "type": "text",
      "id": "slide_timings",
      "label": "Slide timings (ms)",
      "default": "12000,6000"
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 200,
      "step": 4,
      "default": 0,
      "unit": "px",
      "label": "Padding Top"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 200,
      "step": 4,
      "default": 80,
      "unit": "px",
      "label": "Padding Bottom"
    },
    {
      "type": "header",
      "content": "Grid Layout"
    },
    {
      "type": "number",
      "id": "span_s",
      "label": "Column Span (Mobile)",
      "default": 2
    },
    {
      "type": "number",
      "id": "span_m",
      "label": "Column Span (Tablet)",
      "default": 4
    },
    {
      "type": "number",
      "id": "span_l",
      "label": "Column Span (Desktop)",
      "default": 6
    },
    {
      "type": "number",
      "id": "span_xl",
      "label": "Column Span (Wide)",
      "default": 8
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Manual Slide",
      "settings": [
        { "type": "image_picker", "id": "image_light", "label": "Image (light mode)" },
        { "type": "image_picker", "id": "image_dark", "label": "Image (dark mode)" },
        { "type": "url", "id": "image_light_url", "label": "Image URL (light mode)" },
        { "type": "url", "id": "image_dark_url", "label": "Image URL (dark mode)" },
        { "type": "text", "id": "alt_text", "label": "Alt text" }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product Carousel"
    }
  ]
}
{% endschema %}
